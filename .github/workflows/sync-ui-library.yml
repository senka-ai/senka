name: Sync UI Library to senka-ui

on:
  push:
    branches: [main]
    paths: ['packages/ui/**']
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even without UI changes'
        required: false
        default: 'false'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run type checking
        run: yarn ui:typecheck

      - name: Run Svelte checking
        run: yarn ui:check

      - name: Build UI library
        run: yarn ui:build

      - name: Run tests
        run: yarn ui:test

      - name: Checkout senka-ui repo
        uses: actions/checkout@v4
        with:
          repository: senka-ai/senka-ui
          token: ${{ secrets.SYNC_TOKEN }}
          path: ./synced-repo

      - name: Prepare sync directory
        run: |
          # Create temporary directory for sync preparation
          mkdir -p ./sync-temp
          
          # Copy UI package contents
          cp -r packages/ui/* ./sync-temp/
          
          # Remove build artifacts and temp files
          rm -rf ./sync-temp/node_modules
          rm -rf ./sync-temp/dist
          rm -rf ./sync-temp/.svelte-kit
          rm -rf ./sync-temp/storybook-static
          rm -rf ./sync-temp/playwright-report
          rm -rf ./sync-temp/test-results
          
          # Create a standalone README for the UI library
          cat > ./sync-temp/README.md << 'EOF'
          # senka-ui
          
          A modern, type-safe Svelte 5 UI component library with full theme support, accessibility standards, and robust state management patterns.
          
          ## Installation
          
          ```bash
          npm install senka-ui
          # Peer dependencies
          npm install svelte @tailwindcss/vite
          ```
          
          ## Usage
          
          ```typescript
          // Import styles
          import 'senka-ui/styles'
          
          // Import components
          import { Button, TextField, Card } from 'senka-ui'
          
          <Button variant="primary" onclick={() => console.log('clicked')}>
            {#snippet children()}
              Click me!
            {/snippet}
          </Button>
          ```
          
          ## Documentation
          
          For full documentation and examples, visit our [Storybook](https://senka-ui-storybook.vercel.app).
          
          ## Development
          
          This package is part of the [Senka monorepo](https://github.com/senka-ai/senka). 
          For development instructions, please see the main repository.
          
          ## License
          
          MIT
          EOF

      - name: Update package.json for standalone repo
        run: |
          cd ./sync-temp
          
          # Update repository URLs to point to standalone repo
          node -e "
            const pkg = require('./package.json');
            pkg.repository.url = 'https://github.com/senka-ai/senka-ui.git';
            pkg.bugs.url = 'https://github.com/senka-ai/senka-ui/issues';
            pkg.homepage = 'https://github.com/senka-ai/senka-ui';
            delete pkg.repository.directory;
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2));
          "

      - name: Sync to senka-ui repository
        run: |
          cd ./synced-repo
          
          # Get current commit info from monorepo
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG="$(cd .. && git log -1 --pretty=format:'%s' $COMMIT_SHA)"
          
          # Clear existing content (except .git and GitHub workflows)
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.github' -exec rm -rf {} + 2>/dev/null || true
          
          # Copy prepared sync content
          cp -r ../sync-temp/* .
          cp -r ../sync-temp/.* . 2>/dev/null || true
          
          # Configure git
          git config user.name "senka-sync-bot"
          git config user.email "sync-bot@senka.ai"
          
          # Check if there are changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to sync"
            echo "sync_performed=false" >> $GITHUB_OUTPUT
          else
            # Commit and push changes
            git add .
            git commit -m "Sync from monorepo: $COMMIT_MSG

            Source commit: $COMMIT_SHA
            Synced by: ${{ github.actor }}
            
            ðŸ¤– Auto-synced from senka-ai/senka monorepo"
            git push origin main
            echo "sync_performed=true" >> $GITHUB_OUTPUT
            echo "âœ… Successfully synced UI library to senka-ui repository"
          fi

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ”„ UI library changes will be synced to [senka-ai/senka-ui](https://github.com/senka-ai/senka-ui) when this PR is merged.'
            })